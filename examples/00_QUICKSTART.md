# How To Use The HISE IDEs

HISE (the Human Immune System Explorer) is the Allen Institute for Immunology's research hub that allows for data storage, visualization, and analysis in the cloud. You can learn more about the different facets of HISE [here](https://docs.google.com/document/d/1WGksyc6nGtw-BB-lAO7_QVunSUCg_hyDAzeHPmPw_Hc).

This Jupyterlab Notebook IDE is an environment for exploring data and deriving further insights using the HISE R package.

See the notebooks in the `examples` directory for examples of how to analyze specific types of data from HISE.

If you find that any of these method names are outdated, you can always use `help(package = "hise")` at any time to look at a list of methods available to you as a HISE user. Typing `?hise::method_name` will give you an explanation of the method and its required and optional parameters.

## Useful Shortcuts

You may notice that hitting Enter inside a notebook will take you to the next line inside the notebook, rather than executing your code. To quickly execute code, use **Shift-Enter**.

Hit **Tab** when typing a method name to autocomplete the method name. Once you've typed the parentheses, hitting Tab will show you the available parameters for that method. You can do the same thing to look through the available properties of an object.

**All method names should be prepended with the hise:: prefix.**

## Finding files in HISE

To work with files from HISE in the IDE, you need to know the desired file’s ID, formatted as a UUID.

You have two options for finding a list of file IDs to work with: **Advanced Search** in the HISE UI (recommended), or the **getFileDescriptors** method in the HISE SDK. 

Note that both options will only return files that can subsequently be read. Certain files, such as the raw data of a scRNA-seq run are not available to the IDE. The output of the scRNA-seq pipeline, labeled scRNA-seq files, is available. In general, all the results generated by a pipeline are available, as well as some other useful files such as QC'd FCS files.

### Using Advanced Search

The recommended approach is to use the Advanced Search interface to build and execute a query that will find all the files you want to work with in the IDE.

On the HISE website, go to Search > Advanced Search to navigate to the query building interface. (See the [Advanced Search](https://docs.google.com/presentation/d/1HVVvzO9eWk298SHTrHmYb_kPGNacPjwicaBl0Td1uHw/edit#slide=id.gbbafd4d375_1_350) section in the HISE Overview slide deck for more detailed information on how to build a query.)

Once you’ve executed your query with the View Results button in the bottom right of the search page, you will see a list of files that matched your search query. Select the files you wish to analyze, then click **View IDE Script** to see the HISE SDK call that you will need to make to download those files into your IDE. Click the “Copy Script” button at the bottom of the modal window to copy the whole command to your clipboard.

You can then paste that command into HISE to download all those files into your IDE. See the section Reading files below for more information.

### Using getFileDescriptors

Another way to find files to work with is to use the getFileDescriptors method in the HISE SDK. This will return a list of file IDs of all files that match the filter you provide, which you can then use as a parameter for the readFiles method to actually download those files. See the Reading files section below.

In the following example, we look for QC'd FCS files that all originate from the same batch:

`fcss <- hise::getFileDescriptors("fileType" = "FlowCytometry", filter = list("file.batchID" = "B008"))`

After you verify that files were found (e.g. with `length(fcss)`), you can find metadata information about the found files, For example, for information on the subject of the first file:

`fcss[[1]]$subject`

You can also locate the first file's guid:

`fcss[[1]]$file$id`

This would return something like this: '32f52bca-1c0c-474a-9ee5-3ed63hd864d5', which you can then use as part of the call to `hise::readFiles`.

### Inspecting Search Queries

To view the inputs and outputs of a previously saved query in HISE, use the hise::readQuery method with a valid query UUID.  To rerun the query inside the IDE, use the hise::runQuery method.

## Reading files

Once you have a list of file IDs you’d like to work with, you can read the files into the IDE with the `hise::readFiles` method.  If you use Advanced Search on the HISE website to find these file IDs, the View IDE Script button will give you the exact command to run.

This method will download each of the files to your IDE instance, and then return a data frame of the actual data from each file, as well as each file’s corresponding descriptors (i.e, metadata on the file, the associated sample, and the subject.)

If you find that your R kernel freezes after trying to perform readFiles on a large amount of data, you may want to do the downloading and the data structure conversion separately, since depending on the amount of data, you might be asking to create a very large data frame.  Use the method `hise::cacheFiles` to just download each file to the cache directory, and then separately convert to an R structure at a later time.

While `hise::readFiles` is a nice catch-all for any valid data type, there are also some read methods specific to the type of data requested, for when you may want to work with the data in a more specific way.

For instance, to work with a single-cell RNA file in a Seurat-friendly format, you can use:

`f <- hise::readSCRNAFileSeurat('9f6d7ab5-1c7b-4709-9455-3d8ff3fbb6c8')`

For a full list of read methods, see the SDK help page (type `help(package = "hise")`). If you start up a new IDE instance, you will notice an “examples” directory with some demo notebooks that showcase some of these methods.

When you read in a file from HISE, it will be downloaded to disk in the IDE in the `cache` directory, and the method will return an object containing the values and descriptors.  

### Server-side filtering
All of the filetype-specific read* methods allow for various filtering parameters. This allows you to grab just a subset of data from a file. Look at the method documentation with `?hise::methodName` to see their various filtering options.

The generic `hise::readFiles` method can take any of these parameters, in the form of a named list where each name is a valid filter name from one of the more specific read* methods. As an example, `hise::readFiles(list("a45a52b4-3d23-449d-921d-c22fb17b6b91"), list("cellNames" = "/Cells/Singlets-H/Singlets-W/Cleanup/Viable"))` will filter down to show only the data for that cell name, as long as the provided file ID(s) can be filtered in that way according to their filetype-specific read method.

This is the only case where the file is not downloaded to disk; it is only loaded into memory. Depending on the size of the file you’re asking for, returning the filtered data can be quite slow, so it is generally best to use as narrow a filter as possible.

### Reading result-sets
A result-set is a user-created grouping of multiple files. They can be handy if you want to organize some of the files you’ve been working with into an arbitrary group that can be downloaded into the IDE with one UUID instead of a long list of them.  You can create result-sets in the UI from the Files page, by clicking on valid files one by one, and then adding them to a new or existing result-set using the Preview Results page.  If you find this to be inefficient, just getting a list of file IDs from the Advanced Search results page and using readFiles may be a better option.  You can find the uuid of the result-set on the Result-sets page.


## Uploading to HISE

Result-sets are groupings of similar files, making it easier to work with data from multiple samples at once. 

You can use the "uploadResult" method to upload a new result-set (consisting of at least one file generated in the IDE) into HISE:

uploadResult(
  file,
  fileType = NULL,
  inputFileIds,
  sampleIds,
  resultTitle,
  resultDescription = NULL,
  studyIds = NULL,
  prompt = TRUE
)

The following arguments are required:

- *file*: the local path to the file (.h5/csv/png) to save
- *inputFileIds*: a list of HISE file ids that provide source data for this result
- *sampleIds*: a list of HISE sample ids that this result incorporates
- *resultTitle*: title for this result, must be between 10 - 255 characters

Optional arguments:

- *studyIds*: a list of HISE study IDs to which this result should belong.
- *resultDescription*: A description of the data inside this result for easier identification later.
- *prompt*: (default TRUE) prompt before saving.

When successful, it returns the result ID. The result will be available for viewing in the HISE UI (https://allenimmunology.org) on the "Result-sets" page, and can be downloaded into another IDE later using the read methods mentioned above.

### Persisting Private Files

There are times where you may want to save a file for use in another of your HISE IDE instances, but the file doesn't feel finished or important enough to store as an official result-set in HISE. In these cases, you can upload the file into your own designated private user folder. The only ones with access to these folders will be yourself and admin users from the software team. You can have up to 5 private folders.

- **createPrivateFolder** - Create a private folder for use as a scratch space, with an optional file expiration and description. If set, file expiration represents a number of days after which the files inside the folder will be automatically deleted.
- **updatePrivateFolder** - Update the file expiration or description of your private folder.
- **deletePrivateFolder** - Delete an existing private folder. Will only work if the folder is empty.
- **uploadFileToPrivateFolder** - Uploads a local file to the specified private folder.
- **downloadFileFromPrivateFolder** - Downloads a file from the specified folder to the present working directory of your IDE instance.
- **listFilesInAllPrivateFolders** - List all folders that belong to you, and the files inside them.
- **listFilesInPrivateFolder** - List all files inside the given private folder.
- **moveFileInPrivateFolder** - Move a file from one private folder to another.
- **renameFileInPrivateFolder** - Give a file in a private folder a new name.
- **deleteFileInPrivateFolder** - Delete a file in a private folder.
- **findPrivateFolderOfFile** - Returns the name of the private folder that the given file belongs to.

Currently the download method only allows you to download one file at a time.  To download multiple at once, you will need to iterate through the results of the list method.  Here’s an example of grabbing all the RDS files from a private folder:

```
filelist <- hise::listFilesInAllPrivateFolders()
foldersel <- 'my-folder'
rowsel <- filelist$folder == foldersel
filenames <- filelist[rowsel,2]
fileindices <- grep(pattern = ".*RDS",unlist(filenames))
downloadlist <- lapply(unlist(filenames)[fileindices],function(file) {
    hise::downloadFileFromPrivateFolder(fileName = file,folderName = foldersel)
}
```

## Project Folders

A project may be configured so that certain data sets uploaded in the associated watch folder, will be made available to a so-called project folder instead of getting picked up by automated pipelines. This configuration setup is for instance interesting for pilot or other experimental data not suited for pipelines. 

Project folders are project-specific, read-only spaces for multiple users that will allow these users to load data directly into the IDE, mark files for deletion that are no longer necessary, and upload derived insights to storage in HISE.

If you use a watch folder to ingest files of which some need to go to analysis pipelines and others need to go to a project folder, the support group can set this up provided the files can be distinguished at ingest. As an alternative, support can create a dedicated watch folder with all content always going to the project folder. 

The HISE SDK provides specific methods for files in project folders:
- **archiveFileInProjectFolder** - Mark a file in a project folder to be archived.
- **deleteFileInProjectFolder** - Mark a file in a project folder to be deleted in the future after the retention period on the project folder bucket has been reached.
- **downloadFileFromProjectFolder** - Downloads a file from the specified project folder.
- **listFilesInAllProjectFolders** - List all files in all project folders that this user has access to.
- **listFilesInProjectFolders** - List all files in the specified project folders.
- **listProjectFolders** - List all project folders that this user has access to.
- **undoArchiveFileInProjectFolder** - Mark a file that was previously marked to be archived as available again.
- **undoDeleteFileInProjectFolder** - Mark a file that was previously marked to be deleted as available again.

If you have questions about setting up a new project folder or believe you should be given access to an existing project folder, please contact **immunology-support@alleninstitute.org**. 
